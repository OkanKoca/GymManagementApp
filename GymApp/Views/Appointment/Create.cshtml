@model GymApp.ViewModels.AppointmentCreateViewModel
@{
    ViewData["Title"] = "Yeni Randevu";
}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-gradient bg-primary text-white py-3">
                <h4 class="mb-0"><i class="bi bi-calendar-plus me-2"></i>Yeni Randevu Oluþtur</h4>
            </div>
            <div class="card-body p-4">
                <form asp-action="Create" method="post" id="appointmentForm">
                    <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                    <!-- Eðitmen ve Hizmet Seçimi -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card border h-100">
                                <div class="card-body">
                                    <label asp-for="TrainerId" class="form-label fw-semibold">
                                        <i class="bi bi-person-badge text-primary me-1"></i>@Html.DisplayNameFor(m => m.TrainerId)
                                    </label>
                                    <select asp-for="TrainerId" asp-items="@ViewBag.Trainers" class="form-select form-select-lg" id="trainerSelect">
                                        <option value="">-- Eðitmen Seçin --</option>
                                    </select>
                                    <span asp-validation-for="TrainerId" class="text-danger small"></span>
                                    <div id="trainerInfo" class="mt-3 d-none">
                                        <div class="alert alert-light border">
                                            <div id="trainerDetails"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border h-100">
                                <div class="card-body">
                                    <label asp-for="ServiceId" class="form-label fw-semibold">
                                        <i class="bi bi-clipboard-check text-success me-1"></i>@Html.DisplayNameFor(m => m.ServiceId)
                                    </label>
                                    <select asp-for="ServiceId" asp-items="@ViewBag.Services" class="form-select form-select-lg" id="serviceSelect">
                                        <option value="">-- Hizmet Seçin --</option>
                                    </select>
                                    <span asp-validation-for="ServiceId" class="text-danger small"></span>
                                    <div id="serviceInfo" class="mt-3 d-none">
                                        <div class="alert alert-light border">
                                            <div id="serviceDetails"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarih ve Saat -->
                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <label asp-for="AppointmentDate" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event text-info me-1"></i>@Html.DisplayNameFor(m => m.AppointmentDate)
                            </label>
                            <input asp-for="AppointmentDate" class="form-control form-control-lg" type="date"
                                   min="@DateTime.Today.ToString("yyyy-MM-dd")" id="dateSelect" />
                            <span asp-validation-for="AppointmentDate" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="AppointmentTime" class="form-label fw-semibold">
                                <i class="bi bi-clock text-warning me-1"></i>@Html.DisplayNameFor(m => m.AppointmentTime)
                            </label>
                            <input asp-for="AppointmentTime" class="form-control form-control-lg" type="time" id="timeSelect" />
                            <span asp-validation-for="AppointmentTime" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Müsaitlik Durumu -->
                    <div id="availabilityInfo" class="mt-4 d-none">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Eðitmen Müsaitliði</h6>
                            <div id="availabilityDetails"></div>
                        </div>
                    </div>

                    <!-- Dolu Saatler Uyarýsý -->
                    <div id="busyTimesInfo" class="mt-3 d-none">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle me-2"></i>Bu Tarihteki Dolu Saatler</h6>
                            <div id="busyTimesDetails"></div>
                        </div>
                    </div>

                    <!-- Notlar -->
                    <div class="mt-4">
                        <label asp-for="Notes" class="form-label fw-semibold">
                            <i class="bi bi-sticky text-secondary me-1"></i>@Html.DisplayNameFor(m => m.Notes)
                        </label>
                        <textarea asp-for="Notes" class="form-control" rows="3"
                                  placeholder="Varsa eklemek istediðiniz notlar (örn: özel istekler, saðlýk durumu vb.)"></textarea>
                        <span asp-validation-for="Notes" class="text-danger small"></span>
                    </div>

                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-arrow-left me-1"></i> Geri
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-check-circle me-1"></i> Randevu Oluþtur
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bilgilendirme Kartý -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <h6 class="fw-bold"><i class="bi bi-info-circle text-primary me-2"></i>Bilgilendirme</h6>
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <div class="d-flex">
                            <div class="bg-warning bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-hourglass-split text-warning"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Onay Süreci</small>
                                <span>Randevunuz admin tarafýndan onaylanacaktýr.</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex">
                            <div class="bg-info bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-bell text-info"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Bildirim</small>
                                <span>Onay durumu randevularým sayfasýnda görünür.</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex">
                            <div class="bg-danger bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-x-circle text-danger"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Ýptal</small>
                                <span>Randevuyu istediðiniz zaman iptal edebilirsiniz.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
             $(document).ready(function () {
          var trainers = @Html.Raw(Json.Serialize(ViewBag.Trainers));
                    var services = @Html.Raw(Json.Serialize(ViewBag.Services));

               // Eðitmen seçildiðinde
            $('#trainerSelect').change(function () {
            var trainerId = $(this).val();
                if (trainerId) {
              // API'den eðitmen bilgilerini al
                 $.get('/api/TrainersApi/' + trainerId, function (data) {
               var html = '<strong>' + data.fullName + '</strong><br/>';
         html += '<small class="text-muted"><i class="bi bi-award me-1"></i>' + data.expertise + '</small><br/>';
               html += '<small class="text-muted"><i class="bi bi-building me-1"></i>' + data.gym.name + '</small>';
            $('#trainerDetails').html(html);
               $('#trainerInfo').removeClass('d-none');
               });
         checkAvailability();
                  } else {
            $('#trainerInfo').addClass('d-none');
           }
               });

            // Hizmet seçildiðinde
              $('#serviceSelect').change(function () {
            var serviceId = $(this).val();
                  if (serviceId) {
            $.get('/api/ServicesApi/' + serviceId, function (data) {
                   var html = '<strong>' + data.name + '</strong><br/>';
          html += '<span class="badge bg-primary"><i class="bi bi-clock me-1"></i>' + data.durationMinutes + ' dk</span> ';
         html += '<span class="badge bg-success">' + data.price.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) + '</span>';
           $('#serviceDetails').html(html);
          $('#serviceInfo').removeClass('d-none');
            });
            } else {
        $('#serviceInfo').addClass('d-none');
                  }
         });

                    // Tarih deðiþtiðinde
              $('#dateSelect').change(function () {
                 checkAvailability();
             });

          function checkAvailability() {
            var trainerId = $('#trainerSelect').val();
           var date = $('#dateSelect').val();

          if (trainerId && date) {
             $.get('@Url.Action("GetAvailableSlots", "Appointment")', { trainerId: trainerId, date: date }, function (data) {
             // Müsaitlik bilgisi
                if (data.availability && data.availability.length > 0) {
                 var html = '<ul class="mb-0 small">';
         var days = ['Pazar', 'Pazartesi', 'Salý', 'Çarþamba', 'Perþembe', 'Cuma', 'Cumartesi'];
           var selectedDate = new Date(date);
           var dayName = days[selectedDate.getDay()];

            data.availability.forEach(function (a) {
        html += '<li><strong>' + dayName + ':</strong> ' + a.from + ' - ' + a.to + '</li>';
             });
          html += '</ul>';
               $('#availabilityDetails').html(html);
         $('#availabilityInfo').removeClass('d-none');
                  } else {
               $('#availabilityDetails').html('<span class="text-danger">Eðitmen bu gün müsait deðil!</span>');
              $('#availabilityInfo').removeClass('d-none');
               }

                 // Dolu saatler
               if (data.existingAppointments && data.existingAppointments.length > 0) {
                var busyHtml = '<ul class="mb-0 small">';
            data.existingAppointments.forEach(function (a) {
               var start = new Date(a.startAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
          var end = new Date(a.endAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
         busyHtml += '<li class="text-danger">' + start + ' - ' + end + '</li>';
           });
             busyHtml += '</ul>';
              $('#busyTimesDetails').html(busyHtml);
                    $('#busyTimesInfo').removeClass('d-none');
              } else {
           $('#busyTimesInfo').addClass('d-none');
         }
           });
                    } else {
                 $('#availabilityInfo').addClass('d-none');
         $('#busyTimesInfo').addClass('d-none');
         }
             }
                });
    </script>
}
